{% comment %}make an array of non-archived plan_news items{% endcomment %}
{% assign plan_news_list = site.plan_news | sort: 'path' | reverse %}
{% assign topitems = "" | split: ',' %}
{% assign archive = "" | split: ',' %}
{% assign showMoreCnt = 4 %}
{% for item in plan_news_list %}{% unless item.path contains '/_hidden/' %}
{% assign folder = item.path | split: '/' | shift | pop | join: '/' %}
{% if folder == '' %}
  {% assign topitems = topitems | push: item %}
{% else %}
  {% assign archive = archive | push: item %}
{% endif %}
{% endunless %}{% endfor %}
{% comment %}topitems is now top plan news, archive is the stuff in accordions below,
            both reverse sorted{% endcomment %}

{% comment %}Do the top level{% endcomment %}
{% assign searchBar = 1 %}
{% assign itemSize = topitems | size %}
{% if itemSize > 0 %}
<section class="plan-news" markdown="1">
{% assign lastHeader = '' %}
{% assign cnt = 0 %}
{% for item in topitems %}
{% assign cnt = forloop.index %}
{% if cnt == showMoreCnt %}
<div id="more-items-content-plan-news" class="hide">
{% endif %}
  {% assign showHeader = 1 %}
  {% assign newHeader = item.path | split: '/' | last | truncate: 7, "" %}
  {% if newHeader == lastHeader %}{% assign showHeader = 0 %}{% endif %}
  {% assign lastHeader = newHeader %}
  {% include plan-news-item.html entry=item showHeader=showHeader searchBar=searchBar %}
  {% assign searchBar = 0 %}
{% endfor %}
{% if cnt >= showMoreCnt %}
</div>
<div id="more--plan-news" class="see-more" onClick="showMoreForms('', 'plan-news');">
  <span>See more</span>
</div>
{% endif %}
</section>
{% endif %}

{% comment %}Do the accordions{% endcomment %}
{% assign lastFolder = folder %}
{% assign itemSize = archive | size %}
{% if itemSize > 0 %}
{% assign lastHeader = '' %}
<section class="plan-news-archive" markdown="1">
{% assign item = archive | first %}
{% assign folder = item.path | split: '/' | shift | pop | join: '/' %}
{% assign lastFolder = folder %}
## Archived news and announcements
<ul class="usa-accordion">
<li>
<button class="usa-accordion-button" aria-expanded="false" aria-controls="year-{{folder}}">{{folder}}</button>
<div id="year-{{folder}}" class="usa-accordion-content" markdown="1">
{% for item in archive %}
  {% unless item.path contains "/_hidden/" %}
  {% assign folder = item.path | split: '/' | shift | pop | join: '/' %}
  {% if folder != lastFolder %}
{% assign lastFolder = folder %}
</div>
</li>
<li>
<button class="usa-accordion-button" aria-expanded="false" aria-controls="year-{{folder}}">{{folder}}</button>
<div id="year-{{folder}}" class="usa-accordion-content" markdown="1">
  {% endif %}
  {% assign showHeader = 1 %}
  {% assign newHeader = item.path | split: '/' | last | truncate: 7, "" %}
  {% if newHeader == lastHeader %}{% assign showHeader = 0 %}{% endif %}
  {% assign lastHeader = newHeader %}
  {% include plan-news-item.html entry=item showHeader=showHeader searchBar=searchBar %}
  {% assign searchBar = 0 %}
  {% endunless %}
{% endfor %}
</div>
</li>
</ul>
</section>
{% endif %}
